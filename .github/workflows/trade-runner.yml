name: PB1 Trade Runner

permissions:
  contents: write

concurrency:
  group: trade-bot-state
  cancel-in-progress: false

on:
  push:
    branches: [ main, nullim ]
    paths-ignore:
      - "bot_state/**"
  workflow_dispatch:
  schedule:
    # ‚è∞ UTC cron (KST = UTC+9)
    - cron: "50-59/5 23 * * *"   # 08:50-08:59 KST
    - cron: "*/5 0-1 * * *"       # 09:00-10:59 KST
    - cron: "0 2 * * *"           # 11:00 KST boundary
    - cron: "*/5 5 * * *"         # 14:00-14:59 KST
    - cron: "0-30/5 6 * * *"      # 15:00-15:30 KST

jobs:
  run-trade:
    if: github.ref != 'refs/heads/bot-state' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    # Note: cancel-in-progress=false relies on lock file; timeout increased to allow pre-open waits.
    timeout-minutes: 180
    env:
      BOTSTATE_BRANCH: bot-state
      STRATEGY_MODE: "LIVE"
      LIVE_TRADING_ENABLED: "1"
      DISABLE_LIVE_TRADING: "0"
      DRY_RUN: "0"
      EXPECT_LIVE_TRADING: "1"
      EXPECT_KIS_ENV: "practice"
      PB1_ENTRY_ENABLED: "1"
      KIS_ENV: "practice"
      API_BASE_URL: "https://openapivts.koreainvestment.com:29443"
      KIS_APP_KEY: ${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}
      KIS_APP_SECRET: ${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}
      APP_KEY: ${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}
      APP_SECRET: ${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}
      CANO: ${{ secrets.CANO }}
      ACNT_PRDT_CD: ${{ secrets.ACNT_PRDT_CD }}
      STATE_RECONCILE_APPLY: "1"
      MORNING_WINDOW_START: "08:50"
      MORNING_WINDOW_END: "11:00"
      MORNING_EXIT_START: "09:00"
      MORNING_EXIT_END: "09:20"
      AFTERNOON_WINDOW_START: "14:00"
      AFTERNOON_WINDOW_END: "15:30"
      CLOSE_AUCTION_START: "15:20"
      CLOSE_AUCTION_END: "15:30"
      LEDGER_BASE_DIR: "bot_state/trader_ledger"
      LEDGER_LOOKBACK_DAYS: "120"
      BOTSTATE_LOCK_TTL_SEC: "1800"
      PYTHONUNBUFFERED: "1"
      MAX_WAIT_BEFORE_MORNING_MIN: "120"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set git identity
        run: |
          git config user.name "trade-bot"
          git config user.email "trade-bot@users.noreply.github.com"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Resolve trading day and safety flags
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python - <<'PY'
          import os
          from trader.time_utils import is_trading_day, now_kst

          today_trading = is_trading_day(now_kst())
          kis_env = os.environ.get("KIS_ENV", "")
          reconcile_apply = "1" if kis_env == "practice" else "0"
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
              if today_trading:
                  f.write("PB1_ENTRY_ENABLED=1\n")
                  f.write("DISABLE_LIVE_TRADING=0\n")
                  f.write("DRY_RUN=0\n")
              else:
                  f.write("PB1_ENTRY_ENABLED=0\n")
                  f.write("DISABLE_LIVE_TRADING=1\n")
                  f.write("DRY_RUN=1\n")
                  f.write("DIAGNOSTIC_FORCE_RUN=1\n")
              f.write(f"STATE_RECONCILE_APPLY={reconcile_apply}\n")
          print(f"trading_day={today_trading}")
          PY

      - name: Compile modules
        run: |
          python -m compileall trader

      - name: Run PB1 only
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m trader.pb1_runner --window auto --phase auto --target-branch ${BOTSTATE_BRANCH}
