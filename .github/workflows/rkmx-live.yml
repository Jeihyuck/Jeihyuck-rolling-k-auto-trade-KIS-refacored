name: RKMax Live (Unified Trade Monitor)

on:
  workflow_dispatch:
  push:
    branches:
      - rkmax-week
  schedule:
    # 평일 08:50 KST (23:50 UTC, Sun-Thu)
    - cron: "50 23 * * 0-4"

jobs:
  monitor-trade:
    name: Monitor & Rebalance
    runs-on: ubuntu-latest
    # 만약 Environment 시크릿을 쓰신다면 아래 주석 해제하고 prod 등을 맞춰주세요.
    # environment: prod

    env:
      TZ: Asia/Seoul

      # KIS / Account
      APP_KEY: ${{ secrets.KIS_APP_KEY }}
      APP_SECRET: ${{ secrets.KIS_APP_SECRET }}
      CANO: ${{ secrets.KIS_CANO }}
      ACNT_PRDT_CD: ${{ secrets.KIS_ACNT_PRDT_CD }}
      KIS_ENV: ${{ secrets.KIS_ENV }}   # vts or real

      # 전략 파라미터
      PARTIAL1: "0.5"
      PARTIAL2: "0.3"
      TRAIL_PCT: "0.007"
      FAST_STOP: "0.01"
      ATR_STOP_MULT: "1.5"
      TIME_STOP_HHMM: "13:00"
      SELL_FORCE_TIME: "14:45"
      MIN_TRADES: "5"
      MAX_MDD_PCT: "30"
      MIN_WINRATE: "50"
      MIN_CUMRET: "2"
      TOP_K_LIMIT: "20"
      MIN_TARGET_RET_M_PCT: "8"
      K_MIN: "0.1"
      K_MAX: "0.9"
      K_STEP: "0.1"
      TOTAL_CAPITAL: "10000000"
      MIN_QTY_PER_TICKET: "1"
      DAILY_CAPITAL: "10000000"
      MAX_POSITIONS: "8"
      CAPITAL_PER_SYMBOL: "100000"
      ALLOW_AFTER_HOURS: "0"
      ORDER_THROTTLE_SEC: "0.3"
      REBALANCE_DAYS: "7"
      REBALANCE_OUT_DIR: "rebalance_results"
      SLIPPAGE_ENTER_GUARD_PCT: "1.5"
      TRAIL_DISABLE_MINUTES: "5"
      SUSPICIOUS_LOG: "trader/suspicious_targets.log"
      LOG_LEVEL: "INFO"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -e
          python -V
          pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Check required secrets presence (no value print)
        run: |
          set -e
          for k in APP_KEY APP_SECRET KIS_ENV CANO ACNT_PRDT_CD; do
            v="${!k}"
            if [ -n "$v" ]; then
              echo "::notice title=Secret presence::$k=SET"
            else
              echo "::warning title=Secret missing::$k=EMPTY"
            fi
          done

      - name: Write runtime config
        run: |
          set -e
          mkdir -p configs
          cat > configs/rkmax-live.yaml <<'YAML'
          mode: daytrade
          universe: KOSDAQ_TOP50
          k_params:
            method: rkmax
            lookback_months: 1
          slippage:
            max_pct: 0.0025
            max_extra_ticks: 2
          take_profit:
            tp1_pct: 0.008
            tp2_pct: 0.015
          trailing:
            pct: 0.007
            disable_minutes: ${TRAIL_DISABLE_MINUTES}
          stops:
            fast_stop_pct: ${FAST_STOP}
            atr_mult: ${ATR_STOP_MULT}
          sizing:
            scheme: equal
            clip_min: 0.5
            clip_max: 1.5
          time_rules:
            trade_start_hhmm: "09:00"
            trade_end_hhmm:   "14:45"
            sell_force_window:
              start_hhmm: "14:40"
              end_hhmm:   "14:45"
          swing:
            enabled: false
            hold_days: 3
            adx_min: 20
            use_tema_filter: true
          retries:
            max_attempts: 5
            backoff_base_sec: 0.5
          logging:
            level: ${LOG_LEVEL}
            json: true
          YAML
          echo "=== configs/rkmax-live.yaml ==="
          sed -n '1,200p' configs/rkmax-live.yaml

      - name: Start FastAPI (nohup)
        run: |
          set -e
          echo "[API] Starting FastAPI (nohup) ..."
          # 앱 모듈 탐색 (rolling_k_auto_trade_api.main 우선, 없으면 trader.api)
          python -c "import importlib; import sys; importlib.import_module('rolling_k_auto_trade_api.main'); sys.stdout.write('OK')" >/dev/null 2>&1 \
            && TARGET="rolling_k_auto_trade_api.main:app" \
            || TARGET="trader.api:app"

          nohup uvicorn "${TARGET}" --host 127.0.0.1 --port 8000 > fastapi.log 2>&1 &
          PID=$!
          echo "[API] FastAPI started: PID=${PID}"

          # 준비 대기 (/docs 200/401)
          for i in $(seq 1 30); do
            sleep 1
            CODE=$(curl -sS -o /dev/null -w '%{http_code}' http://127.0.0.1:8000/docs || echo 000)
            if [ "$CODE" = "200" ] || [ "$CODE" = "401" ]; then
              echo "[API] Ready after ${i}s"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "[API][WARN] not ready within timeout — continuing anyway"
            fi
          done

          echo "=== fastapi.log (tail 80) ==="
          tail -n 80 fastapi.log || true

      # 리밸런싱 생성 — 항상 시도
      - name: Rebalance – Generate (always)
        if: ${{ always() }}
        run: |
          set -e
          DATE=$(date '+%F')
          echo "[REB] POST /rebalance/run/${DATE}?force_generate=true"
          curl -sS -X POST "http://127.0.0.1:8000/rebalance/run/${DATE}?force_generate=true" \
               -H "Content-Type: application/json" \
               -d '{}' || echo "[REB] endpoint not found or failed (ignored)."

      # 리밸런싱 확인/저장 — 항상 실행 (jq 사용)
      - name: Rebalance – Verify & Save (always)
        if: ${{ always() }}
        run: |
          set -e
          DATE=$(date '+%F')
          mkdir -p "${REBALANCE_OUT_DIR}"
          echo "[REB] GET /rebalance/selected/${DATE}"
          RES=$(curl -sS "http://127.0.0.1:8000/rebalance/selected/${DATE}" || echo '{}')
          echo "${RES}" > "${REBALANCE_OUT_DIR}/selected-${DATE}.json"

          COUNT=$(jq -r '(.selected // .selected_stocks // .data.selected_stocks // []) | length' "${REBALANCE_OUT_DIR}/selected-${DATE}.json" 2>/dev/null || echo 0)
          echo "[REB] selected count: ${COUNT}"
          if [ "${COUNT}" -eq 0 ]; then
            echo "[REB][WARN] no selected_stocks (weekend/after-hours or empty generator output)"
          fi

      # 라이브 루프 프리플라이트 (평일/장내만 true)
      - id: preflight
        name: Preflight guard for live loop
        run: |
          set -e
          DOW=$(date +%u)   # 1=Mon ... 7=Sun
          NOW=$(date +%H:%M)
          CONTINUE=true
          if [ "$DOW" -ge 6 ]; then CONTINUE=false; fi
          if [[ "$NOW" < "09:00" || "$NOW" > "14:45" ]]; then CONTINUE=false; fi
          echo "continue=${CONTINUE}" >> "$GITHUB_OUTPUT"
          echo "[PREFLIGHT] DOW=$DOW NOW=$NOW CONTINUE=$CONTINUE"

      # 라이브 트레이딩 루프 — 장중에만
      - name: Unified live loop (09:00→14:45 KST)
        if: ${{ steps.preflight.outputs.continue == 'true' }}
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          set -e
          # 계좌 필수값이 없으면 루프 시작을 막고 로그만 남김 (실거래 보호)
          if [ -z "${CANO}" ] || [ -z "${ACNT_PRDT_CD}" ]; then
            echo "::warning title=Account env missing::CANO/ACNT_PRDT_CD is empty — live loop will not trade."
          fi
          echo "[INIT] $(date '+%F %T %Z') — start unified live loop"
          python -m trader.trader || true
          echo "[DONE] $(date '+%F %T %Z') — loop ended"

      - name: CEO Report
        if: ${{ always() }}
        run: |
          set -e
          python -m trader.report_ceo || true

      - name: Upload Rebalance Result
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: rebalance-results
          path: rebalance_results/*.json
          if-no-files-found: warn

      - name: Upload Logs (optional)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-fills
          path: |
            trader/logs/*.json
            logs/*.json
            trader/suspicious_targets.log
            fills/*.csv
          if-no-files-found: warn

      - name: Show FastAPI log tail
        if: ${{ always() }}
        run: |
          echo "::group::FastAPI Server Log"
          tail -n 200 fastapi.log || true
          echo "::endgroup::"
  