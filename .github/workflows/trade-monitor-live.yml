name: Trade Monitor LIVE (practice VTS)

permissions:
  contents: write

concurrency:
  group: trade-bot-state
  cancel-in-progress: false

on:
  schedule:
    - cron: "*/5 0-6 * * 1-5"
  workflow_dispatch:
    inputs:
      run_minutes:
        description: "Minutes to run trader loop (60s interval)"
        required: false
        default: "360"

jobs:
  trade-live:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    env:
      # === KIS 인증키 ===
      KIS_APP_KEY: ${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}
      KIS_APP_SECRET: ${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}
      APP_KEY: ${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}
      APP_SECRET: ${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}

      CANO: ${{ secrets.CANO }}
      ACNT_PRDT_CD: ${{ secrets.ACNT_PRDT_CD }}
      KIS_ENV: "practice"
      API_BASE_URL: "https://openapivts.koreainvestment.com:29443"

      # === trader.py 운영 파라미터 ===
      PARTIAL1: "0.5"
      PARTIAL2: "0.3"
      TRAIL_PCT: "0.02"
      FAST_STOP: "0.01"
      ATR_STOP: "1.5"

      TIME_STOP_HHMM: "13:00"
      SELL_FORCE_TIME: "14:40"
      SELL_ALL_BALANCES_AT_CUTOFF: "0"
      FORCE_SELL_PASSES_CUTOFF: "2"
      FORCE_SELL_PASSES_CLOSE: "4"

      DEFAULT_PROFIT_PCT: "3.0"
      DEFAULT_LOSS_PCT: "5.0"

      SLIPPAGE_LIMIT_PCT: "0.25"
      SLIPPAGE_ENTER_GUARD_PCT: "2.5"

      VWAP_TOL: "0.003"

      W_MAX_ONE: "0.25"
      W_MIN_ONE: "0.03"

      REBALANCE_ANCHOR: "weekly"
      FORCE_WEEKLY_REBALANCE: "0"
      MOMENTUM_OVERRIDES_FORCE_SELL: "1"

      # 레짐/지수
      KOSDAQ_INDEX_CODE: "KOSDAQ"
      KOSDAQ_ETF_FALLBACK: "229200"

      REG_BULL_MIN_UP_PCT: "0.5"
      REG_BULL_MIN_MINUTES: "10"
      REG_BEAR_VWAP_MINUTES: "10"
      REG_BEAR_DROP_FROM_HIGH: "0.7"
      REG_BEAR_STAGE1_MINUTES: "20"
      REG_BEAR_STAGE2_ADD_DROP: "0.5"

      REG_PARTIAL_S1: "0.30"
      REG_PARTIAL_S2: "0.30"

      TRAIL_PCT_BULL: "0.025"
      TRAIL_PCT_BEAR: "0.012"
      TP_PROFIT_PCT_BULL: "3.5"

      MARKET_DATA_WHEN_CLOSED: "0"

      DIAGNOSTIC_ONLY: "0"
      DIAGNOSTIC_FORCE_RUN: "0"
      DIAGNOSTIC_ENABLED: "0"

      # ===== LIVE 강제 =====
      DRY_RUN: "0"
      DISABLE_LIVE_TRADING: "0"
      LIVE_TRADING_ENABLED: "1"
      EXPECT_LIVE_TRADING: "1"
      EXPECT_KIS_ENV: "practice"
      STRATEGY_MODE: "LIVE"

      # 전략 1만
      ACTIVE_STRATEGIES: "1"

      # 엔진 ON/OFF
      DISABLE_KOSDAQ_LOOP: "0"
      DISABLE_KOSPI_ENGINE: "1"

      # 안전: 장외 금지
      ALLOW_AFTER_HOURS: "0"
      ALLOW_ADOPT_UNMANAGED: "0"

      # 배분/속도
      DAILY_CAPITAL: "250000000"
      API_RATE_SLEEP_SEC: "0.3"

      # === VWAP 분봉 TR ===
      KIS_TR_ID_INTRADAY_CHART: "FHKST03010200"
      KIS_TR_ID_INTRADAY_CHART_REAL: "FHKST03010200"

      # === FastAPI 리밸런싱 서버(선정 필터) ===
      MIN_TRADES: "5"
      MAX_MDD_PCT: "30"
      MIN_WINRATE: "50"
      MIN_CUMRET: "2"
      TOP_K_LIMIT: "20"
      TOTAL_CAPITAL: "10000000"
      MIN_QTY_PER_TICKET: "1"
      K_MIN: "0.1"
      K_MAX: "0.9"
      K_STEP: "0.1"
      REBALANCE_OUT_DIR: "rebalance_results"

      RUN_MINUTES: ${{ github.event.inputs.run_minutes || 360 }}

    steps:
      - name: Preflight (secrets/event/practice)
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" != "schedule" && "${GITHUB_EVENT_NAME}" != "workflow_dispatch" ]]; then
            echo "[FAIL] Invalid trigger: ${GITHUB_EVENT_NAME}" >&2
            exit 1
          fi
          required_envs=(KIS_APP_KEY KIS_APP_SECRET APP_KEY APP_SECRET CANO ACNT_PRDT_CD)
          missing=()
          for key in "${required_envs[@]}"; do
            if [[ -z "${!key:-}" ]]; then
              missing+=("${key}")
            fi
          done
          if (( ${#missing[@]} > 0 )); then
            echo "[FAIL] Missing required secrets/env: ${missing[*]}" >&2
            exit 1
          fi
          if [[ "${KIS_ENV,,}" != "practice" ]]; then
            echo "[FAIL] KIS_ENV must be practice (VTS)" >&2
            exit 1
          fi
          api_lower="${API_BASE_URL,,}"
          if [[ "${api_lower}" != *"openapivts"* ]]; then
            echo "[FAIL] API_BASE_URL must point to openapivts practice endpoint" >&2
            exit 1
          fi
          if ! [[ "${RUN_MINUTES}" =~ ^[0-9]+$ ]]; then
            echo "[FAIL] RUN_MINUTES must be a positive integer" >&2
            exit 1
          fi
          if [[ "${RUN_MINUTES}" -lt 1 ]]; then
            echo "[FAIL] RUN_MINUTES must be >=1" >&2
            exit 1
          fi
          echo "[OK] Preflight checks passed"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: trader_r1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure trader_r1 branch checked out
        run: |
          git checkout trader_r1

      - name: Set git identity
        run: |
          git config user.name "trade-bot"
          git config user.email "trade-bot@users.noreply.github.com"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure state scripts executable
        run: |
          chmod +x scripts/state_pull_plain.sh scripts/state_push_plain.sh || true

      - name: Pull state (plain)
        run: |
          bash scripts/state_pull_plain.sh

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compile modules
        run: |
          python -m compileall trader rolling_k_auto_trade_api portfolio strategy

      - name: Run trader LIVE loop (60s interval)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          set -euo pipefail
          minutes=${RUN_MINUTES}
          for ((i=0; i<minutes; i++)); do
            echo "[TRADER][${i}/${minutes}] cycle start $(date -u --iso-8601=seconds)"
            python -m trader.trader
            if [[ $((i + 1)) -lt minutes ]]; then
              sleep 60
            fi
          done

      - name: Normalize state path
        if: always()
        run: |
          mkdir -p trader/state
          test -f .runtime/state.json && cp -f .runtime/state.json trader/state/state.json || true
          test -f trader/state/state.json && echo "[STATE] trader/state/state.json exists" || echo "[STATE] missing!"

      - name: CEO 리포트 자동 생성
        if: always()
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m trader.report_ceo || true

      - name: Push state (plain)
        if: always()
        run: |
          test -f scripts/state_push_plain.sh && bash scripts/state_push_plain.sh || true

      - name: Upload logs and state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: live-trade-state-and-logs
          path: |
            fastapi.log
            trader/state/state.json
            .runtime/state.json
          if-no-files-found: ignore
