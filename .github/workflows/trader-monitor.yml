name: Trade Monitor (trader_refactor branch)

permissions:
  contents: write

concurrency:
  group: trade-bot-state
  cancel-in-progress: false

on:
  push:
    branches: [ main, nullim ]
    paths-ignore:
      - "bot_state/**"
  pull_request:
    branches: [ main, nullim ]
  schedule:
    - cron: "57 23 * * 0-6"
  workflow_dispatch:


jobs:
  monitor-trade:
    # ğŸ”’ ì•ˆì „ì¥ì¹˜: main ë¸Œëœì¹˜ì—ì„œë§Œ ëª¨ë‹ˆí„°ë§/ìë™ë§¤ë§¤ ì‹¤í–‰
    # if: github.ref == 'refs/heads/main'
    if: github.ref != 'refs/heads/bot-state'
    runs-on: ubuntu-latest

    env:
      #FORCE_TRADING_DAY: "1"   # ğŸ‘ˆ í…ŒìŠ¤íŠ¸ ì‹œì—ë§Œ
      #ALLOW_NON_TRADING_ORDER: "1"
      # === KIS ì¸ì¦í‚¤(ë‘ ì´ë¦„ ëª¨ë‘ ëŒ€ì‘: ë¨¼ì € KIS_*ê°€ ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ APP_* ì‚¬ìš©) ===
      KIS_APP_KEY:    ${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}
      KIS_APP_SECRET: ${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}
      # (ì¼ë¶€ ëª¨ë“ˆì´ APP_*ë¥¼ ì½ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë™ì¼ ê°’ ë™ì‹œ ì£¼ì…)
      APP_KEY:        ${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}
      APP_SECRET:     ${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}

      CANO:           ${{ secrets.CANO }}
      ACNT_PRDT_CD:   ${{ secrets.ACNT_PRDT_CD }}
      KIS_ENV:        ${{ secrets.KIS_ENV }}          # practice / real

      # settings.pyê°€ KIS_ENVë¡œ ìë™íŒë‹¨í•˜ë¯€ë¡œ API_BASE_URLì€ ë³´í†µ ë¶ˆí•„ìš”
      API_BASE_URL:   ${{ secrets.API_BASE_URL }}

      # === trader.py ìš´ì˜ íŒŒë¼ë¯¸í„° ===
      PARTIAL1: "0.5"
      PARTIAL2: "0.3"
      TRAIL_PCT: "0.02"
      FAST_STOP: "0.01"
      ATR_STOP: "1.5"

      TIME_STOP_HHMM: "13:00"
      SELL_FORCE_TIME: "14:40"
      SELL_ALL_BALANCES_AT_CUTOFF: "false"
      FORCE_SELL_PASSES_CUTOFF: "2"
      FORCE_SELL_PASSES_CLOSE: "4"

      DEFAULT_PROFIT_PCT: "3.0"
      DEFAULT_LOSS_PCT: "5.0"

      SLIPPAGE_LIMIT_PCT: "0.25"
      SLIPPAGE_ENTER_GUARD_PCT: "2.5"

      # ğŸ”¸ VWAP ì „ëµìš© í—ˆìš© ì˜¤ì°¨ (ì½”ë“œ CONFIGì˜ VWAP_TOLê³¼ ì—°ê²°)
      # 0.003 = 0.3% / í•„ìš”í•˜ë©´ branch-levelë¡œ ì‰½ê²Œ ì¡°ì • ê°€ëŠ¥
      VWAP_TOL: "0.003"

      W_MAX_ONE: "0.25"
      W_MIN_ONE: "0.03"

      REBALANCE_ANCHOR: "weekly"
      FORCE_WEEKLY_REBALANCE: "0"
      MOMENTUM_OVERRIDES_FORCE_SELL: "true"

      # ë ˆì§/ì§€ìˆ˜
      KOSDAQ_INDEX_CODE: "KOSDAQ"
      KOSDAQ_ETF_FALLBACK: "229200"

      REG_BULL_MIN_UP_PCT: "0.5"
      REG_BULL_MIN_MINUTES: "10"
      REG_BEAR_VWAP_MINUTES: "10"
      REG_BEAR_DROP_FROM_HIGH: "0.7"
      REG_BEAR_STAGE1_MINUTES: "20"
      REG_BEAR_STAGE2_ADD_DROP: "0.5"

      REG_PARTIAL_S1: "0.30"
      REG_PARTIAL_S2: "0.30"

      TRAIL_PCT_BULL: "0.025"
      TRAIL_PCT_BEAR: "0.012"
      TP_PROFIT_PCT_BULL: "3.5"

      MARKET_DATA_WHEN_CLOSED: "false"

      # ë°°ë¶„/ì†ë„
      DAILY_CAPITAL: "250000000"
      API_RATE_SLEEP_SEC: "0.3"

      # === VWAP ë¶„ë´‰ TR (ì„ íƒ: ì½”ë“œì— ê¸°ë³¸ê°’ ì´ë¯¸ ìˆìœ¼ë¯€ë¡œ ìƒëµí•´ë„ ë™ì‘) ===
      # í•œêµ­íˆ¬ìì¦ê¶Œ ì—‘ì…€ ê¸°ì¤€ ì£¼ì‹ë‹¹ì¼ë¶„ë´‰ì¡°íšŒ TR_ID (FHKST03010200)
      KIS_TR_ID_INTRADAY_CHART: "FHKST03010200"
      KIS_TR_ID_INTRADAY_CHART_REAL: "FHKST03010200"

      # === FastAPI ë¦¬ë°¸ëŸ°ì‹± ì„œë²„(ì„ ì • í•„í„°) ===
      MIN_TRADES: "5"
      MAX_MDD_PCT: "30"
      MIN_WINRATE: "50"
      MIN_CUMRET: "2"
      TOP_K_LIMIT: "20"
      TOTAL_CAPITAL: "10000000"
      MIN_QTY_PER_TICKET: "1"
      K_MIN: "0.1"
      K_MAX: "0.9"
      K_STEP: "0.1"
      ALLOW_AFTER_HOURS: "0"
      REBALANCE_OUT_DIR: "rebalance_results"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore state cache (fallback only)
        uses: actions/cache/restore@v4
        with:
          path: |
            bot_state/state.json
            trader/state/state.json
          key: trader-state-${{ github.ref_name }}
          restore-keys: |
            trader-state-${{ github.ref_name }}-
      - name: Save state cache (dispatch only)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/cache/save@v4
        with:
          path: |
            bot_state/state.json
            trader/state/state.json
          key: trader-state-${{ github.ref_name }}

      - name: Set git identity
        run: |
          git config user.name "trade-bot"
          git config user.email "trade-bot@users.noreply.github.com"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure state scripts executable
        if: github.event_name != 'pull_request'
        run: |
          chmod +x scripts/state_pull_plain.sh scripts/state_push_plain.sh || true

      - name: Pull state (plain)
        if: github.event_name != 'pull_request'
        run: |
          bash scripts/state_pull_plain.sh

      - name: Dependencies ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ledger smoke test
        run: |
          python -m trader.ledger_test

      - name: Decide trading mode/env
        id: decide-mode
        run: |
          ALLOW="${{ vars.ALLOW_LIVE_ON_PUSH || '0' }}"
          EVENT="${{ github.event_name }}"
          RUN_LIVE="1"
          if [ "$EVENT" = "pull_request" ]; then
            RUN_LIVE="0"
          elif [ "$EVENT" = "push" ] && [ "$ALLOW" != "1" ]; then
            RUN_LIVE="0"
          fi

          ALLOW_FOR_ENV="$ALLOW"

          if [ "$RUN_LIVE" = "1" ]; then
            DRY_RUN="0"
            EXPECT_LIVE="1"
            DISABLE_LIVE="0"
            LIVE_ENABLED="1"
            STRATEGY_MODE="LIVE"
            ALLOW_FOR_ENV="1"
          else
            DRY_RUN="1"
            EXPECT_LIVE="0"
            DISABLE_LIVE="0"
            LIVE_ENABLED="1"
            STRATEGY_MODE="INTENT_ONLY"
          fi

          {
            echo "allow_live_on_push=$ALLOW_FOR_ENV"
            echo "run_live=$RUN_LIVE"
            echo "dry_run=$DRY_RUN"
            echo "expect_live=$EXPECT_LIVE"
            echo "disable_live=$DISABLE_LIVE"
            echo "live_enabled=$LIVE_ENABLED"
            echo "strategy_mode=$STRATEGY_MODE"
          } >> "$GITHUB_OUTPUT"

      - name: (CI) Trading mode summary
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          ALLOW_LIVE_ON_PUSH: ${{ steps.decide-mode.outputs.allow_live_on_push }}
          EXPECT_LIVE_TRADING: ${{ steps.decide-mode.outputs.expect_live }}
          DRY_RUN: ${{ steps.decide-mode.outputs.dry_run }}
          DISABLE_LIVE_TRADING: ${{ steps.decide-mode.outputs.disable_live }}
          LIVE_TRADING_ENABLED: ${{ steps.decide-mode.outputs.live_enabled }}
          STRATEGY_MODE: ${{ steps.decide-mode.outputs.strategy_mode }}
        run: |
          python - <<'PY'
          import os
          event = os.getenv("GITHUB_EVENT_NAME")
          allow = os.getenv("ALLOW_LIVE_ON_PUSH")
          expect = os.getenv("EXPECT_LIVE_TRADING")
          dry_run = os.getenv("DRY_RUN")
          disable = os.getenv("DISABLE_LIVE_TRADING")
          live_enabled = os.getenv("LIVE_TRADING_ENABLED")
          mode = os.getenv("STRATEGY_MODE")
          print(f"event={event}")
          print(f"ALLOW_LIVE_ON_PUSH={allow}")
          print(f"EXPECT_LIVE_TRADING={expect}")
          print(f"DRY_RUN={dry_run}")
          print(f"DISABLE_LIVE_TRADING={disable}")
          print(f"LIVE_TRADING_ENABLED={live_enabled}")
          print(f"STRATEGY_MODE={mode}")
          if dry_run == "1":
            print("Trading mode: DRY_RUN (no live trades).")
          else:
            print("Trading mode: LIVE enabled.")
          PY

      - name: (ì§„ë‹¨) í•µì‹¬ í™˜ê²½ë³€ìˆ˜ ì£¼ì… ì—¬ë¶€ë§Œ í™•ì¸
        run: |
          python - << 'PY'
          import os
          def chk(k):
              v = os.getenv(k) or ''
              print(f"{k}: {'OK' if v else 'MISSING'} (len={len(v)})")
          for k in [
              'KIS_APP_KEY','KIS_APP_SECRET','APP_KEY','APP_SECRET',
              'CANO','ACNT_PRDT_CD','KIS_ENV'
          ]:
              chk(k)
          PY

      # ğŸ” ì—¬ê¸° ì¶”ê°€: ì‹¤ì œë¡œ ì–´ë–¤ trader.trader íŒŒì¼ì„ ì½ëŠ”ì§€ í™•ì¸
      - name: (ë””ë²„ê·¸) trader ëª¨ë“ˆ ê²½ë¡œ ë° ë‚´ìš© í™•ì¸
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python - << 'PY'
          import trader
          from trader import trader as t
          print("trader package path:", trader.__file__)
          print("trader.trader module path:", t.__file__)
          print("=== HEAD OF trader.trader ===")
          try:
              with open(t.__file__, 'r', encoding='utf-8') as f:
                  for i in range(1, 80):
                      line = f.readline()
                      if not line:
                          break
                      print(f"{i:03}: {line.rstrip()}")
          except Exception as e:
              print("ERROR while reading trader.trader:", e)
          PY

      - name: ë¦¬ë°¸ëŸ°ì‹± API ì„œë²„ ì‹¤í–‰ (FastAPI, ë°±ê·¸ë¼ìš´ë“œ, ë¡œê·¸íŒŒì¼)
        run: |
          nohup uvicorn rolling_k_auto_trade_api.main:app --host 0.0.0.0 --port 8000 > fastapi.log 2>&1 &
          sleep 30  # ì„œë²„ ê¸°ë™ ëŒ€ê¸°

      - name: Compile modules
        run: |
          python -m compileall trader rolling_k_auto_trade_api
      - name: trader ìë™ë§¤ë§¤ ë¡œì§ ì‹¤í–‰
        env:
          EXPECT_LIVE_TRADING: ${{ steps.decide-mode.outputs.expect_live }}
          DRY_RUN: ${{ steps.decide-mode.outputs.dry_run }}
          DISABLE_LIVE_TRADING: ${{ steps.decide-mode.outputs.disable_live }}
          LIVE_TRADING_ENABLED: ${{ steps.decide-mode.outputs.live_enabled }}
          STRATEGY_MODE: ${{ steps.decide-mode.outputs.strategy_mode }}
          ALLOW_LIVE_ON_PUSH: ${{ steps.decide-mode.outputs.allow_live_on_push }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m trader.trader

      - name: CEO ë¦¬í¬íŠ¸ ìë™ ìƒì„±
        if: always()
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m trader.report_ceo || true

      - name: Verify CEO report exists
        if: always()
        run: |
          ls -al trader/logs || true

      - name: Push state (plain)
        if: github.event_name != 'pull_request'
        run: |
          test -f scripts/state_push_plain.sh && bash scripts/state_push_plain.sh || true

      - name: Save state snapshot as artifact (audit only)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trader-state-${{ github.run_id }}
          path: |
            trader/state/state.json
            bot_state/state.json
            trader/logs/CEO_Report_*.md
            trader/logs/ledger.jsonl
          retention-days: 30

      - name: Rebalance JSON artifact ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rebalance-results
          path: rebalance_results/*.json
          if-no-files-found: warn
          retention-days: 60

      - name: Trades ë¡œê·¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trade-logs
          path: trader/logs/*.json
          if-no-files-found: ignore
          retention-days: 14

      - name: FastAPI ë¡œê·¸ ì¶œë ¥ (cat)
        if: always()
        run: |
          echo "::group::FastAPI Server Log"
          cat fastapi.log || true
          echo "::endgroup::"

      - name: FastAPI ë¡œê·¸ ì—…ë¡œë“œ (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fastapi-log
          path: fastapi.log
          if-no-files-found: ignore
          retention-days: 14

      






  
