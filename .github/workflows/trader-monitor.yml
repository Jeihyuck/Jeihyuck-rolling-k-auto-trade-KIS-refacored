name: Trade Monitor (trader_refactor branch)

permissions:
  contents: write

concurrency:
  group: trade-bot-state
  cancel-in-progress: false

on:
  push:
    branches: [ main, trader_refactor ]
    paths-ignore:
      - "bot_state/**"
  pull_request:
    branches: [ main, trader_refactor ]
  # âœ… UTC 23:40 = KST 08:40 (ì¥ ì‹œì‘ ì „ ëŒ€ê¸°/ì¥ì¤‘ LIVE ì‹œì‘ìš©)
  schedule:
    - cron: "40 23 * * 0-6"
  workflow_dispatch:
    inputs:
      run_mode:
        description: "auto=ê·œì¹™ëŒ€ë¡œ, live=ê°•ì œ LIVE(ì¥ì˜¤í”ˆì „ì´ë©´ ëŒ€ê¸° í›„ LIVE), diag=ê°•ì œ DIAG"
        required: false
        default: "auto"
        type: choice
        options: [ auto, live, diag ]
      active_strategies:
        description: "ACTIVE_STRATEGIES (ì˜ˆ: 1 ë˜ëŠ” 1,2,3)"
        required: false
        default: "1"
      run_loop_minutes:
        description: "LIVE ë£¨í”„ ì§€ì† ì‹œê°„(ë¶„). 0ì´ë©´ 1íšŒë§Œ ì‹¤í–‰"
        required: false
        default: "360"
      kis_env:
        description: "practice(ëª¨ì˜/VTS) ë˜ëŠ” real(ì‹¤ê³„ì¢Œ)"
        required: false
        default: "practice"
        type: choice
        options: [ practice, real ]

jobs:
  monitor-trade:
    # ğŸ”’ ì•ˆì „ì¥ì¹˜: bot-state ë¸Œëœì¹˜ëŠ” ì œì™¸
    if: github.ref != 'refs/heads/bot-state'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      #FORCE_TRADING_DAY: "1"   # ğŸ‘ˆ í…ŒìŠ¤íŠ¸ ì‹œì—ë§Œ
      #ALLOW_NON_TRADING_ORDER: "1"

      # === KIS ì¸ì¦í‚¤(ë‘ ì´ë¦„ ëª¨ë‘ ëŒ€ì‘: ë¨¼ì € KIS_*ê°€ ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ APP_* ì‚¬ìš©) ===
      KIS_APP_KEY:    ${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}
      KIS_APP_SECRET: ${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}
      # (ì¼ë¶€ ëª¨ë“ˆì´ APP_*ë¥¼ ì½ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë™ì¼ ê°’ ë™ì‹œ ì£¼ì…)
      APP_KEY:        ${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}
      APP_SECRET:     ${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}

      CANO:           ${{ secrets.CANO }}
      ACNT_PRDT_CD:   ${{ secrets.ACNT_PRDT_CD }}

      # ê¸°ë³¸(ë¹„ì›Œì ¸ ìˆì–´ë„ LIVE ë‹¨ê³„ì—ì„œ ìµœì¢… í™•ì •)
      KIS_ENV:        ${{ secrets.KIS_ENV }}          # practice / real
      # settings.pyê°€ KIS_ENVë¡œ ìë™íŒë‹¨í•˜ë¯€ë¡œ API_BASE_URLì€ ë³´í†µ ë¶ˆí•„ìš”
      API_BASE_URL:   ${{ secrets.API_BASE_URL }}

      # âœ… pushì—ì„œë„ LIVE í—ˆìš©(íŒŒì´ì¬ ìª½ì´ ì´ envë¥¼ ì½ì–´ì•¼ íš¨ê³¼ ìˆìŒ)
      ALLOW_LIVE_ON_PUSH: "1"

      # === trader.py ìš´ì˜ íŒŒë¼ë¯¸í„° ===
      PARTIAL1: "0.5"
      PARTIAL2: "0.3"
      TRAIL_PCT: "0.02"
      FAST_STOP: "0.01"
      ATR_STOP: "1.5"

      TIME_STOP_HHMM: "13:00"
      SELL_FORCE_TIME: "14:40"
      SELL_ALL_BALANCES_AT_CUTOFF: "false"
      FORCE_SELL_PASSES_CUTOFF: "2"
      FORCE_SELL_PASSES_CLOSE: "4"

      DEFAULT_PROFIT_PCT: "3.0"
      DEFAULT_LOSS_PCT: "5.0"

      SLIPPAGE_LIMIT_PCT: "0.25"
      SLIPPAGE_ENTER_GUARD_PCT: "2.5"

      # ğŸ”¸ VWAP ì „ëµìš© í—ˆìš© ì˜¤ì°¨ (ì½”ë“œ CONFIGì˜ VWAP_TOLê³¼ ì—°ê²°)
      VWAP_TOL: "0.003"

      W_MAX_ONE: "0.25"
      W_MIN_ONE: "0.03"

      REBALANCE_ANCHOR: "weekly"
      FORCE_WEEKLY_REBALANCE: "0"
      MOMENTUM_OVERRIDES_FORCE_SELL: "true"

      # ë ˆì§/ì§€ìˆ˜
      KOSDAQ_INDEX_CODE: "KOSDAQ"
      KOSDAQ_ETF_FALLBACK: "229200"

      REG_BULL_MIN_UP_PCT: "0.5"
      REG_BULL_MIN_MINUTES: "10"
      REG_BEAR_VWAP_MINUTES: "10"
      REG_BEAR_DROP_FROM_HIGH: "0.7"
      REG_BEAR_STAGE1_MINUTES: "20"
      REG_BEAR_STAGE2_ADD_DROP: "0.5"

      REG_PARTIAL_S1: "0.30"
      REG_PARTIAL_S2: "0.30"

      TRAIL_PCT_BULL: "0.025"
      TRAIL_PCT_BEAR: "0.012"
      TP_PROFIT_PCT_BULL: "3.5"

      MARKET_DATA_WHEN_CLOSED: "false"

      # ë°°ë¶„/ì†ë„
      DAILY_CAPITAL: "250000000"
      API_RATE_SLEEP_SEC: "0.3"

      # === VWAP ë¶„ë´‰ TR ===
      KIS_TR_ID_INTRADAY_CHART: "FHKST03010200"
      KIS_TR_ID_INTRADAY_CHART_REAL: "FHKST03010200"

      # === FastAPI ë¦¬ë°¸ëŸ°ì‹± ì„œë²„(ì„ ì • í•„í„°) ===
      MIN_TRADES: "5"
      MAX_MDD_PCT: "30"
      MIN_WINRATE: "50"
      MIN_CUMRET: "2"
      TOP_K_LIMIT: "20"
      TOTAL_CAPITAL: "10000000"
      MIN_QTY_PER_TICKET: "1"
      K_MIN: "0.1"
      K_MAX: "0.9"
      K_STEP: "0.1"
      ALLOW_AFTER_HOURS: "0"
      REBALANCE_OUT_DIR: "rebalance_results"

      # ê¸°ë³¸ê°’(ìˆ˜ë™ ì…ë ¥ ì—†ì„ ë•Œ)
      ACTIVE_STRATEGIES: "1"
      RUN_LOOP_MINUTES: "360"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set git identity
        run: |
          git config user.name "trade-bot"
          git config user.email "trade-bot@users.noreply.github.com"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Dependencies ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compile modules
        run: |
          python -m compileall trader rolling_k_auto_trade_api

      - name: Ledger smoke test
        run: |
          python -m trader.ledger_test

      # ===== í•µì‹¬: pushë“  ë­ë“  "ì¥ ì˜¤í”ˆ ì „ì´ë©´ ëŒ€ê¸° í›„ LIVE" / ì£¼ë§ì€ DIAG =====
      - name: Decide mode + (optional) wait seconds
        id: decide
        env:
          RUN_MODE: ${{ github.event_name == 'workflow_dispatch' && inputs.run_mode || 'auto' }}
          INPUT_ACTIVE_STRATEGIES: ${{ github.event_name == 'workflow_dispatch' && inputs.active_strategies || env.ACTIVE_STRATEGIES }}
          INPUT_RUN_LOOP_MINUTES: ${{ github.event_name == 'workflow_dispatch' && inputs.run_loop_minutes || env.RUN_LOOP_MINUTES }}
          INPUT_KIS_ENV: ${{ github.event_name == 'workflow_dispatch' && inputs.kis_env || '' }}
          DEFAULT_KIS_ENV: ${{ secrets.KIS_ENV }}
          SECRET_API_BASE_URL: ${{ secrets.API_BASE_URL }}
          SECRET_API_BASE_URL_REAL: ${{ secrets.API_BASE_URL_REAL }}
        run: |
          python - << 'PY'
          import os
          from datetime import datetime, time
          try:
            from zoneinfo import ZoneInfo
            tz = ZoneInfo("Asia/Seoul")
          except Exception:
            tz = None

          event = os.getenv("GITHUB_EVENT_NAME", "")
          run_mode = (os.getenv("RUN_MODE") or "auto").strip().lower()
          active_strategies = (os.getenv("INPUT_ACTIVE_STRATEGIES") or "1").strip()
          run_loop_minutes = (os.getenv("INPUT_RUN_LOOP_MINUTES") or "360").strip()

          input_kis_env = (os.getenv("INPUT_KIS_ENV") or "").strip().lower()
          default_kis_env = (os.getenv("DEFAULT_KIS_ENV") or "").strip().lower()
          kis_env = input_kis_env or default_kis_env or "practice"
          kis_env = "real" if kis_env == "real" else "practice"

          # base url ê²°ì • (realì¼ ë•Œë§Œ real url ì‚¬ìš©)
          vts_url = "https://openapivts.koreainvestment.com:29443"
          real_fallback = "https://openapi.koreainvestment.com:9443"
          secret_base = (os.getenv("SECRET_API_BASE_URL") or "").strip()
          secret_real = (os.getenv("SECRET_API_BASE_URL_REAL") or "").strip()
          api_base_url = vts_url if kis_env == "practice" else (secret_real or real_fallback or secret_base)

          now = datetime.now(tz) if tz else datetime.now()
          wk = now.weekday()  # 0=Mon ... 5=Sat 6=Sun
          is_weekend = (wk >= 5)

          open_t = time(8, 40)
          close_t = time(15, 40)

          sleep_seconds = 0
          reason = ""

          # PRì€ ì•ˆì „ìƒ ê±°ë˜/ëŒ€ê¸° ëª¨ë‘ ê¸ˆì§€
          if event == "pull_request":
            mode = "NONE"
            reason = "pull_request => NO TRADING"
          else:
            if is_weekend:
              mode = "DIAG"
              reason = "weekend => DIAG"
            else:
              if run_mode == "diag":
                mode = "DIAG"
                reason = "forced diag"
              elif run_mode == "live":
                if now.time() < open_t:
                  mode = "WAIT_LIVE"
                  target = datetime.combine(now.date(), open_t, tzinfo=now.tzinfo) if getattr(now, "tzinfo", None) else datetime.combine(now.date(), open_t)
                  sleep_seconds = max(0, int((target - now).total_seconds()))
                  reason = "forced live, wait until open"
                elif now.time() < close_t:
                  mode = "LIVE"
                  reason = "forced live, in market window"
                else:
                  mode = "DIAG"
                  reason = "forced live but after close => DIAG"
              else:
                if now.time() < open_t:
                  mode = "WAIT_LIVE"
                  target = datetime.combine(now.date(), open_t, tzinfo=now.tzinfo) if getattr(now, "tzinfo", None) else datetime.combine(now.date(), open_t)
                  sleep_seconds = max(0, int((target - now).total_seconds()))
                  reason = "auto: pre-open => wait then LIVE"
                elif now.time() < close_t:
                  mode = "LIVE"
                  reason = "auto: market window => LIVE"
                else:
                  mode = "DIAG"
                  reason = "auto: after close => DIAG"

          run_live = "true" if mode in ("LIVE", "WAIT_LIVE") else "false"
          run_diag = "true" if mode == "DIAG" else "false"
          needs_state = "true" if mode in ("LIVE", "WAIT_LIVE", "DIAG") else "false"

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
            f.write(f"mode={mode}\n")
            f.write(f"run_live={run_live}\n")
            f.write(f"run_diag={run_diag}\n")
            f.write(f"needs_state={needs_state}\n")
            f.write(f"sleep_seconds={sleep_seconds}\n")
            f.write(f"reason={reason}\n")
            f.write(f"active_strategies={active_strategies}\n")
            f.write(f"run_loop_minutes={run_loop_minutes}\n")
            f.write(f"kis_env={kis_env}\n")
            f.write(f"api_base_url={api_base_url}\n")

          print("==== DECISION ====")
          print("event:", event)
          print("now:", now.isoformat())
          print("run_mode:", run_mode)
          print("mode:", mode)
          print("sleep_seconds:", sleep_seconds)
          print("reason:", reason)
          print("kis_env:", kis_env)
          print("api_base_url:", api_base_url)
          print("active_strategies:", active_strategies)
          print("run_loop_minutes:", run_loop_minutes)
          PY

      # ===== ìƒíƒœ ë³µêµ¬/ì €ì¥ =====
      - name: Restore state cache (fallback only)
        if: steps.decide.outputs.needs_state == 'true'
        uses: actions/cache/restore@v4
        with:
          path: |
            bot_state/state.json
            trader/state/state.json
          key: trader-state-${{ github.ref_name }}
          restore-keys: |
            trader-state-${{ github.ref_name }}-

      - name: Ensure state scripts executable
        if: steps.decide.outputs.needs_state == 'true' && github.event_name != 'pull_request'
        run: |
          chmod +x scripts/state_pull_plain.sh scripts/state_push_plain.sh || true

      - name: Pull state (plain)
        if: steps.decide.outputs.needs_state == 'true' && github.event_name != 'pull_request'
        run: |
          bash scripts/state_pull_plain.sh || true

      # ì¥ ì˜¤í”ˆ ì „ì´ë©´ ì—¬ê¸°ì„œ ëŒ€ê¸°
      - name: Wait until market open (KST 08:40)
        if: steps.decide.outputs.mode == 'WAIT_LIVE' && steps.decide.outputs.sleep_seconds != '0'
        run: |
          SLEEP="${{ steps.decide.outputs.sleep_seconds }}"
          echo "Waiting ${SLEEP}s until market open... reason=${{ steps.decide.outputs.reason }}"
          sleep "$SLEEP"

      # ğŸ” (ì§„ë‹¨) í•µì‹¬ í™˜ê²½ë³€ìˆ˜ ì£¼ì… ì—¬ë¶€ë§Œ í™•ì¸
      - name: (ì§„ë‹¨) í•µì‹¬ í™˜ê²½ë³€ìˆ˜ ì£¼ì… ì—¬ë¶€ë§Œ í™•ì¸
        if: steps.decide.outputs.needs_state == 'true'
        run: |
          python - << 'PY'
          import os
          def chk(k):
              v = os.getenv(k) or ''
              print(f"{k}: {'OK' if v else 'MISSING'} (len={len(v)})")
          for k in [
              'KIS_APP_KEY','KIS_APP_SECRET','APP_KEY','APP_SECRET',
              'CANO','ACNT_PRDT_CD','KIS_ENV','ALLOW_LIVE_ON_PUSH'
          ]:
              chk(k)
          print("GITHUB_EVENT_NAME:", os.getenv("GITHUB_EVENT_NAME"))
          PY

      # ğŸ” ì‹¤ì œë¡œ ì–´ë–¤ trader.trader íŒŒì¼ì„ ì½ëŠ”ì§€ í™•ì¸
      - name: (ë””ë²„ê·¸) trader ëª¨ë“ˆ ê²½ë¡œ ë° ë‚´ìš© í™•ì¸
        if: steps.decide.outputs.needs_state == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python - << 'PY'
          import trader
          from trader import trader as t
          print("trader package path:", trader.__file__)
          print("trader.trader module path:", t.__file__)
          PY

      - name: ë¦¬ë°¸ëŸ°ì‹± API ì„œë²„ ì‹¤í–‰ (FastAPI, ë°±ê·¸ë¼ìš´ë“œ, ë¡œê·¸íŒŒì¼)
        if: steps.decide.outputs.needs_state == 'true'
        run: |
          nohup uvicorn rolling_k_auto_trade_api.main:app --host 0.0.0.0 --port 8000 > fastapi.log 2>&1 &
          sleep 30

      # ===== LIVE ì‹¤í–‰ =====
      - name: trader LIVE
        if: steps.decide.outputs.run_live == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}
          KIS_ENV: ${{ steps.decide.outputs.kis_env }}
          API_BASE_URL: ${{ steps.decide.outputs.api_base_url }}

          # âœ… ê°•ì œ LIVE ê²€ì¦(ì½”ë“œê°€ ì´ê±¸ ë³´ê³  dry_runì´ë©´ ì£½ê²Œ í•˜ëŠ” êµ¬ì¡°ì¼ ë•Œ)
          EXPECT_LIVE_TRADING: "1"
          DRY_RUN: "0"
          DISABLE_LIVE_TRADING: "0"
          LIVE_TRADING_ENABLED: "1"
          STRATEGY_MODE: "LIVE"

          ACTIVE_STRATEGIES: ${{ steps.decide.outputs.active_strategies }}
          RUN_LOOP_MINUTES: ${{ steps.decide.outputs.run_loop_minutes }}

          # âœ… pushì—ì„œë„ LIVE í—ˆìš©(íŒŒì´ì¬ ì½”ë“œê°€ ë°˜ì˜í•´ì•¼ í•¨)
          ALLOW_LIVE_ON_PUSH: "1"
        run: |
          python - << 'PY'
          import os, sys
          must = ["KIS_APP_KEY","KIS_APP_SECRET","CANO","ACNT_PRDT_CD"]
          miss = [k for k in must if not (os.getenv(k) or "").strip()]
          if miss:
              print("FATAL missing secrets:", miss)
              sys.exit(2)
          print("[LIVE PRECHECK]")
          print("GITHUB_EVENT_NAME=", os.getenv("GITHUB_EVENT_NAME"))
          print("ALLOW_LIVE_ON_PUSH=", os.getenv("ALLOW_LIVE_ON_PUSH"))
          print("KIS_ENV=", os.getenv("KIS_ENV"))
          print("API_BASE_URL=", os.getenv("API_BASE_URL"))
          print("EXPECT_LIVE_TRADING=", os.getenv("EXPECT_LIVE_TRADING"))
          print("DRY_RUN=", os.getenv("DRY_RUN"),
                "DISABLE_LIVE_TRADING=", os.getenv("DISABLE_LIVE_TRADING"),
                "LIVE_TRADING_ENABLED=", os.getenv("LIVE_TRADING_ENABLED"),
                "STRATEGY_MODE=", os.getenv("STRATEGY_MODE"))
          PY
          python -m trader.trader

      # ===== DIAG ì‹¤í–‰ =====
      - name: trader DIAG
        if: steps.decide.outputs.run_diag == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}
          DRY_RUN: "1"
          DISABLE_LIVE_TRADING: "1"
          LIVE_TRADING_ENABLED: "0"
          EXPECT_LIVE_TRADING: "0"
          STRATEGY_MODE: "INTENT_ONLY"

          ACTIVE_STRATEGIES: ${{ steps.decide.outputs.active_strategies }}
          RUN_LOOP_MINUTES: "0"

          MARKET_DATA_WHEN_CLOSED: "true"
        run: |
          python -m trader.trader

      - name: CEO ë¦¬í¬íŠ¸ ìë™ ìƒì„±
        if: always()
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m trader.report_ceo || true

      - name: Verify CEO report exists
        if: always()
        run: |
          ls -al trader/logs || true

      - name: Push state (plain)
        if: steps.decide.outputs.needs_state == 'true' && github.event_name != 'pull_request'
        run: |
          test -f scripts/state_push_plain.sh && bash scripts/state_push_plain.sh || true

      - name: Save state snapshot as artifact (audit only)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trader-state-${{ github.run_id }}
          path: |
            trader/state/state.json
            bot_state/state.json
            trader/logs/CEO_Report_*.md
            trader/logs/ledger.jsonl
          retention-days: 30

      - name: Rebalance JSON artifact ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rebalance-results
          path: rebalance_results/*.json
          if-no-files-found: warn
          retention-days: 60

      - name: Trades ë¡œê·¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trade-logs
          path: trader/logs/*.json
          if-no-files-found: ignore
          retention-days: 14

      - name: FastAPI ë¡œê·¸ ì¶œë ¥ (cat)
        if: always()
        run: |
          echo "::group::FastAPI Server Log"
          cat fastapi.log || true
          echo "::endgroup::"

      - name: FastAPI ë¡œê·¸ ì—…ë¡œë“œ (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fastapi-log
          path: fastapi.log
          if-no-files-found: ignore
          retention-days: 14






  