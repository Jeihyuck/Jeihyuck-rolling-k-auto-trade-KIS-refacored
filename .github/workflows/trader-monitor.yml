name: Trade Monitor (PB1 One-Shot)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "57 23 * * 0-6"
  workflow_dispatch:

concurrency:
  group: trade-bot-state
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  pb1:
    if: "${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}"
    runs-on: ubuntu-latest

    env:
      # --- Secrets mapping (QUOTE IMPORTANT) ---
      KIS_APP_KEY: "${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}"
      KIS_APP_SECRET: "${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}"
      APP_KEY: "${{ secrets.KIS_APP_KEY != '' && secrets.KIS_APP_KEY || secrets.APP_KEY }}"
      APP_SECRET: "${{ secrets.KIS_APP_SECRET != '' && secrets.KIS_APP_SECRET || secrets.APP_SECRET }}"
      CANO: "${{ secrets.CANO }}"
      ACNT_PRDT_CD: "${{ secrets.ACNT_PRDT_CD }}"
      KIS_ENV: "${{ secrets.KIS_ENV }}"
      API_BASE_URL: "${{ secrets.API_BASE_URL }}"

      # --- PB1 live controls ---
      BOTSTATE_BRANCH: "bot-state"
      BOTSTATE_WORKTREE_DIR: "_botstate"
      DISABLE_LIVE_TRADING: "0"
      LIVE_TRADING_ENABLED: "1"
      DRY_RUN: "0"
      STRATEGY_MODE: "LIVE"
      PB1_ENTRY_ENABLED: "1"
      PB1_DIAG_LEVEL: "2"
      PB1_SHADOW_LIVE: "1"

      # --- Windows / wait ---
      PB1_WAIT_FOR_WINDOW: "1"
      PB1_MAX_WAIT_FOR_WINDOW_MIN: "240"
      MARKET_OPEN_HHMM: "08:50"
      MARKET_CLOSE_HHMM: "15:30"

      # --- Strategy params (optional) ---
      VWAP_TOL: "0.003"
      DAILY_CAPITAL: "250000000"
      API_RATE_SLEEP_SEC: "0.3"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure git identity (required for botstate commits)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: (Guard) required secrets present
        run: |
          missing=()
          for key in KIS_APP_KEY KIS_APP_SECRET CANO ACNT_PRDT_CD; do
            if [ -z "${!key}" ]; then
              missing+=("$key")
            fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required secrets: ${missing[*]}"
            exit 1
          fi
          echo "Secrets OK. Continue."

      - name: PB1 one-shot run (auto: wait -> live, or diag)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m trader.pb1_runner --window auto --phase auto --target-branch "${BOTSTATE_BRANCH}"

      - name: Upload PB1 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pb1-artifacts
          path: |
            trader/logs/**
            _botstate/bot_state/trader_ledger/**
            _botstate/trader/state/state.json
          if-no-files-found: warn
          retention-days: 30

