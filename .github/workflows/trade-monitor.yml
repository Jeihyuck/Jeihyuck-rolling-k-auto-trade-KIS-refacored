name: Trade Monitor

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "KIS/realtimetrade"
  schedule:
    # 평일 09:00 KST 단발 실행 (GitHub cron은 UTC 기준 → 00:00 UTC == 09:00 KST)
    - cron: "0 0 * * 1-5"

permissions:
  contents: read

concurrency:
  group: trade-monitor-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      KIS_APP_KEY:      ${{ secrets.KIS_APP_KEY }}
      KIS_APP_SECRET:   ${{ secrets.KIS_APP_SECRET }}
      CANO:             ${{ secrets.CANO }}
      ACNT_PRDT_CD:     ${{ secrets.ACNT_PRDT_CD }}
      KIS_ENV:          ${{ secrets.KIS_ENV }}
      API_BASE_URL:     ${{ secrets.API_BASE_URL }}
      SLACK_WEBHOOK:    ${{ secrets.SLACK_WEBHOOK }}
      TZ:               "Asia/Seoul"
      PYTHONPATH:       ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: "${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}"
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ▶ 필수 ENV 프리플라이트 (누락 시 즉시 실패)
      - name: Preflight config check
        shell: bash
        run: |
          python - <<'PY'
          from settings import APP_KEY, APP_SECRET, CANO, ACNT_PRDT_CD, KIS_ENV, API_BASE_URL
          print('[ENV_OK] KIS_APP_KEY =', (APP_KEY[:3]+'***') if APP_KEY else None)
          print('[ENV_OK] CANO        =', CANO)
          print('[ENV_OK] ACNT_PRDT_CD=', ACNT_PRDT_CD)
          print('[ENV_OK] KIS_ENV     =', KIS_ENV)
          print('[ENV_OK] API_BASE_URL=', API_BASE_URL)
          assert APP_KEY and APP_SECRET and CANO and ACNT_PRDT_CD, 'Missing required env vars'
          PY

      # ▶ API 서버 백그라운드 기동 + 헬스/문서 체크
      - name: Run API (background) and wait for readiness
        shell: bash
        run: |
          nohup python -m uvicorn rolling_k_auto_trade_api.main:app --host 127.0.0.1 --port 8000 > fastapi.log 2>&1 &
          echo $! > uvicorn.pid
          echo "⏳ Waiting /health ..."
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8000/health > /dev/null; then
              echo "✅ /health OK"
              break
            fi
            echo "[health] retry $i"; sleep 2
          done
          echo "⏳ Checking /docs ..."
          curl -sf http://127.0.0.1:8000/docs | head -n 1 || (echo '[ERR] /docs not responding' && exit 1)

      # ▶ 등록 라우트 덤프 후 /rebalance/latest 있으면만 호출
      - name: Dump routes & call /rebalance/latest if present
        shell: bash
        run: |
          curl -sf http://127.0.0.1:8000/openapi.json -o openapi.json || echo '{}' > openapi.json
          python - <<'PY'
          import json, pathlib, sys
          data = {}
          try:
              data = json.load(open('openapi.json','r',encoding='utf-8'))
          except Exception: pass
          paths = sorted((data.get('paths') or {}).keys())
          print("=== Registered Paths ===")
          for p in paths: print(p)
          pathlib.Path('routes.txt').write_text("\n".join(paths), encoding='utf-8')
          want = "/rebalance/latest"
          present = want in paths
          print(f"[ROUTES] {want} present? ->", present)
          pathlib.Path('has_rebalance.flag').write_text("1" if present else "0", encoding='utf-8')
          PY
          if [ "$(cat has_rebalance.flag)" = "1" ]; then
            echo "⏳ Calling /rebalance/latest ..."
            curl -sf http://127.0.0.1:8000/rebalance/latest || (echo '[WARN] /rebalance/latest non-2xx'; exit 1)
          else
            echo "[INFO] /rebalance/latest not registered. Skipping."
          fi

      # ▶ 전략 실행(재시도 포함)
      - name: Run trader (with retry)
        shell: bash
        run: |
          MAX_RETRIES=5
          RETRY_DELAY=5
          for i in $(seq 1 $MAX_RETRIES); do
            echo "▶ python -m trader.trader (attempt $i/$MAX_RETRIES)"
            if python -m trader.trader; then
              echo "✅ trader.trader succeeded"
              break
            else
              echo "⚠️ trader.trader failed; retry in ${RETRY_DELAY}s"
              sleep $RETRY_DELAY
            fi
            if [ "$i" -eq "$MAX_RETRIES" ]; then
              echo "❌ trader.trader failed after all retries"
              exit 1
            fi
          done

      # ▶ 리포트(선택)
      - name: Generate CEO report
        run: python -m trader.report_ceo

      # ▶ 로그/산출물 업로드
      - name: Upload artifacts (logs & routes)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trade-monitor-logs
          path: |
            fastapi.log
            uvicorn.pid
            openapi.json
            routes.txt
            **/logs/**

      # ▶ 서버 종료(항상)
      - name: Stop API
        if: always()
        shell: bash
        run: |
          if [ -f uvicorn.pid ]; then kill $(cat uvicorn.pid) || true; fi 
