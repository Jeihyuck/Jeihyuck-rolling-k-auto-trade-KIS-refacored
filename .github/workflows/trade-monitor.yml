name: Trade Monitor

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]  # 필요시 브랜치명 조정
  schedule:
    # 평일 09:00 KST 1회 실행 (GitHub cron은 UTC 기준 → 00:00 UTC == 09:00 KST)
    - cron: "0 0 * * 1-5"

permissions:
  contents: read

concurrency:
  group: trade-monitor-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      KIS_APP_KEY:      ${{ secrets.KIS_APP_KEY }}
      KIS_APP_SECRET:   ${{ secrets.KIS_APP_SECRET }}
      CANO:             ${{ secrets.CANO }}
      ACNT_PRDT_CD:     ${{ secrets.ACNT_PRDT_CD }}
      KIS_ENV:          ${{ secrets.KIS_ENV }}
      API_BASE_URL:     ${{ secrets.API_BASE_URL }}
      SLACK_WEBHOOK:    ${{ secrets.SLACK_WEBHOOK }}
      TZ:               "Asia/Seoul"
      PYTHONPATH:       ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: "${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}"
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Preflight config check
        shell: bash
        run: |
          python - <<'PY'
          from settings import APP_KEY, APP_SECRET, CANO, ACNT_PRDT_CD, KIS_ENV, API_BASE_URL
          print('[ENV_OK] KIS_APP_KEY =', (APP_KEY[:3]+'***') if APP_KEY else None)
          print('[ENV_OK] CANO        =', CANO)
          print('[ENV_OK] ACNT_PRDT_CD=', ACNT_PRDT_CD)
          print('[ENV_OK] KIS_ENV     =', KIS_ENV)
          print('[ENV_OK] API_BASE_URL=', API_BASE_URL)
          assert APP_KEY and APP_SECRET and CANO and ACNT_PRDT_CD, 'Missing required env vars'
          PY

      - name: Run API (background) and wait for readiness
        shell: bash
        run: |
          nohup python -m uvicorn rolling_k_auto_trade_api.main:app --host 127.0.0.1 --port 8000 > fastapi.log 2>&1 &
          echo $! > uvicorn.pid
          echo "⏳ Waiting /health ..."
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8000/health > /dev/null; then
              echo "✅ /health OK"
              break
            fi
            echo "[health] retry $i"; sleep 2
          done
          echo "⏳ Checking /docs ..."
          curl -sf http://127.0.0.1:8000/docs | head -n 1 || (echo '[ERR] /docs not responding' && exit 1)

      - name: Dump registered routes (openapi.json)
        shell: bash
        run: |
          curl -sf http://127.0.0.1:8000/openapi.json -o openapi.json || echo '{}' > openapi.json
          python - <<'PY'
          import json, sys
          with open('openapi.json','r',encoding='utf-8') as f:
              data=json.load(f)
          paths = sorted((data.get('paths') or {}).keys())
          print("=== Registered Paths ===")
          for p in paths: print(p)
          with open('routes.txt','w',encoding='utf-8') as f:
              f.write("\n".join(paths))
          # flag for rebalance
          want = "/rebalance/latest"
          present = want in paths
          print(f"[ROUTES] {want} present? ->", present)
          open('has_rebalance.flag','w').write("1" if present else "0")
          PY

      - name: Call /rebalance/latest if present
        shell: bash
        run: |
          if [ "$(cat has_rebalance.flag)" = "1" ]; then
            echo "⏳ Calling /rebalance/latest ..."
            curl -sf http://127.0.0.1:8000/rebalance/latest || (echo '[WARN] /rebalance/latest returned non-2xx'; exit 1)
          else
            echo "[INFO] /rebalance/latest not registered. Skipping this step."
          fi

      - name: Run trader (with retry)
        shell: bash
        run: |
          MAX_RETRIES=5
          RETRY_DELAY=5
          for i in $(seq 1 $MAX_RETRIES); do
            echo "▶ python -m trader.trader (attempt $i/$MAX_RETRIES)"
            if python -m trader.trader; then
              echo "✅ trader.trader succeeded"
              break
            else
              echo "⚠️ trader.trader failed; retry in ${RETRY_DELAY}s"
              sleep $RETRY_DELAY
            fi
            if [ "$i" -eq "$MAX_RETRIES" ]; then
              echo "❌ trader.trader failed after all retries"
              exit 1
            fi
          done

      - name: Generate CEO report
        run: python -m trader.report_ceo

      - name: Upload artifacts (logs & routes)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trade-monitor-logs
          path: |
            fastapi.log
            uvicorn.pid
            openapi.json
            routes.txt
            **/logs/**

      - name: Stop API
        if: always()
        shell: bash
        run: |
          if [ -f uvicorn.pid ]; then kill $(cat uvicorn.pid) || true; fi
